# -------------------------------------------------------------------
# SIGIC IA: Proxy condicional para llmb (Django + Flask)
# -------------------------------------------------------------------
# Este archivo se monta solo si ENABLE_IA_PROXY=true
# en docker-compose.yml y se incluye dentro del server principal.
# -------------------------------------------------------------------

lua_ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;
lua_ssl_verify_depth 3;
lua_ssl_protocols TLSv1.2 TLSv1.3;
lua_package_path "/usr/local/openresty/lualib/?.lua;;";

# Upstreams idénticos a los nombres de servicio en docker-compose
upstream ia-engine {
    server ia-engine:8000;
}

upstream ia-queue {
    server ia-queue:8000;
}

# Django backend
location ~ ^/llmb/(.*)$ {
    if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' "$http_access_control_request_headers" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
    }

    access_by_lua_file /usr/local/openresty/lualib/auth.lua;

    rewrite ^/llmb/(.*)$ /$1 break;
    proxy_pass http://ia-engine;

    proxy_set_header   Authorization        $http_authorization_upstream;
    proxy_set_header   Cookie               $http_cookie;
    proxy_set_header   Host                 $host;
    proxy_set_header   X-Forwarded-Host     $host;
    proxy_set_header   X-Forwarded-Proto    $scheme;
    proxy_set_header   X-Forwarded-Port     $server_port;
    proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
    proxy_set_header   X-Real-IP            $remote_addr;

    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, X-Requested-With' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    proxy_connect_timeout 5s;
    proxy_read_timeout 300s;
    proxy_next_upstream error timeout http_502 http_503 http_504 non_idempotent;
    proxy_intercept_errors on;
}

# Flask queue
location ~ ^/llmb/queue/(.*)$ {
    if ($request_method = OPTIONS) {
        add_header 'Access-Control-Allow-Origin' "$http_origin" always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' "$http_access_control_request_headers" always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
    }

    access_by_lua_file /usr/local/openresty/lualib/auth.lua;

    rewrite ^/llmb/queue/(.*)$ /$1 break;
    proxy_pass http://ia-queue;

    proxy_set_header   Authorization        $http_authorization_upstream;
    proxy_set_header   Cookie               $http_cookie;
    proxy_set_header   Host                 $host;
    proxy_set_header   X-Forwarded-Host     $host;
    proxy_set_header   X-Forwarded-Proto    $scheme;
    proxy_set_header   X-Forwarded-Port     $server_port;
    proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
    proxy_set_header   X-Real-IP            $remote_addr;

    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, X-Requested-With' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    proxy_connect_timeout 5s;
    proxy_read_timeout 300s;
    proxy_next_upstream error timeout http_502 http_503 http_504 non_idempotent;
    proxy_intercept_errors on;
}

# API y documentación
location ~ ^/llmb/(api|apidocs|flasgger_static|apispec_1.json)/(.*)$ {
    rewrite ^/llmb/(.*)$ /$1 break;
    proxy_pass http://ia-engine;

    proxy_set_header   Authorization        $http_authorization_upstream;
    proxy_set_header   Cookie               $http_cookie;
    proxy_set_header   Host                 $host;
    proxy_set_header   X-Forwarded-Host     $host;
    proxy_set_header   X-Forwarded-Proto    $scheme;
    proxy_set_header   X-Forwarded-Port     $server_port;
    proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
    proxy_set_header   X-Real-IP            $remote_addr;

    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization, X-Requested-With' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    proxy_connect_timeout 5s;
    proxy_read_timeout 300s;
    proxy_next_upstream error timeout http_502 http_503 http_504 non_idempotent;
    proxy_intercept_errors on;
}
